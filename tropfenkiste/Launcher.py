import subprocess
import time
import threading
import Queue

targets = [ '94.45.231.3', '94.45.233.3','94.45.234.3','94.45.235.3','94.45.236.3','94.45.237.3','94.45.238.3','94.45.239.3','94.45.240.3','94.45.241.3','94.45.242.3','94.45.243.3','94.45.244.3','94.45.245.3','94.45.246.3','94.45.247.3' ]
exploit = './exploit.py'
keyfilepath = 'keyfile'
sleeptime = 30


keyfile = open(keyfilepath, 'a+')

roundctr = 1
while True:
  plist = []
  fc = 0
  sc = 0
  ec = 0
  print "Spawning exploits ...."
  for target in targets:
    args = exploit + " " +  target
    plist.append(subprocess.Popen(args, bufsize=-1, shell=True, stdout=subprocess.PIPE))  

  time.sleep(sleeptime)

  for target, process in enumerate(plist):
    process.poll()
    if process.returncode == 0:
      sc += 1
      print "Success for Target " + targets[target]
      key, err = process.communicate()
      print "Key: " + key
      keyfile.write(key)
      keyfile.flush()

    elif process.returncode == None:
      ec += 1
      print "Exploit for Target " + targets[target] + " did not finish, killing"
      process.kill()
    else: 
      fc += 1
      print "Failure for Target " + targets[target]

  print "Stats for round " + str(roundctr) + ": Success: " + str(sc) + " Fail: " + str(fc) + " Error: " + str(ec)
  roundctr += 1
