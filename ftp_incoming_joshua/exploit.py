#!/usr/bin/python2.7

import StringIO
import ftplib
import re
import sys

# Connection information
server = sys.argv[1]

# Establish the connection
ftp = ftplib.FTP()
ftp.connect(server, 10022)

# Hello, Mr Falken :)
ftp.sendcmd('JOSHUA')

# Change to the proper directory
ftp.cwd('/home/enterdie/ftp_root/incoming')

# Loop through matching files and download each one individually
for filename in ftp.nlst('*.dat'):

    tmp = StringIO.StringIO()
    ftp.retrbinary('RETR ' + filename, tmp.write)

    content = tmp.getValue().strip()
    m = re.search(r"'([A-Z0-9]+)'", content)
    if m:
        print m.group(1)

ftp.close()
sys.exit(0)
